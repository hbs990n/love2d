name: Build Love2D Windows (修正版)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025
    
    steps:
    # 1. 克隆 megasource
    - name: Clone Megasource
      uses: actions/checkout@v4
      with:
        repository: love2d/megasource
        path: megasource
    
    # 2. 克隆你的 love2d
    - name: Clone Love2D
      uses: actions/checkout@v4
      with:
        path: megasource/libs/love
    
    # 3. 配置CMake（使用绝对路径）
    - name: Configure CMake
      run: |
        cd megasource
        # 获取当前绝对路径
        $currentDir = (Get-Location).Path
        $installPath = "$currentDir\install"
        Write-Host "安装路径: $installPath"
        
        cmake -B build -S . -T v143 -A x64 --install-prefix "$installPath"
    
    # 4. 编译PACKAGE目标
    - name: Build Package
      run: |
        cd megasource
        cmake --build build --config Release --target PACKAGE
    
    # 5. 查找生成的文件
    - name: Find Generated Files
      run: |
        echo "=== 查找生成的文件 ==="
        cd megasource
        
        # 列出build目录内容
        Write-Host "build目录内容:"
        Get-ChildItem build -File | Select-Object -First 10
        
        # 查找exe和zip文件
        $exeFiles = Get-ChildItem -Path build -Recurse -Filter "*.exe" -File
        $zipFiles = Get-ChildItem -Path build -Recurse -Filter "*.zip" -File
        
        Write-Host "找到 $($exeFiles.Count) 个exe文件"
        Write-Host "找到 $($zipFiles.Count) 个zip文件"
        
        if ($exeFiles.Count -gt 0) {
            foreach ($exe in $exeFiles) {
                $sizeMB = [math]::Round($exe.Length / 1MB, 2)
                Write-Host "  - $($exe.Name) ($sizeMB MB)"
                # 复制最大的exe文件
                if ($sizeMB -gt 5) {
                    Copy-Item $exe.FullName ..\love_big.exe -Force
                    Write-Host "    ✓ 复制为 love_big.exe"
                }
            }
        }
        
        if ($zipFiles.Count -gt 0) {
            foreach ($zip in $zipFiles) {
                $sizeMB = [math]::Round($zip.Length / 1MB, 2)
                Write-Host "  - $($zip.Name) ($sizeMB MB)"
                Copy-Item $zip.FullName ..\
            }
        }
    
    # 6. 上传结果
    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: love2d-build-output
        path: |
          *.exe
          *.zip
          megasource/build/*.exe
          megasource/build/*.zip
        if-no-files-found: warn
