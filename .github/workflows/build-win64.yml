name: Build Love2D Windows (带NSIS)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025
    
    steps:
    # 1. 安装NSIS
    - name: Install NSIS
      run: winget install nsis --disable-interactivity --accept-source-agreements --accept-package-agreements
    
    # 2. 克隆仓库
    - name: Clone Megasource
      uses: actions/checkout@v4
      with:
        repository: love2d/megasource
        path: megasource
    
    - name: Clone Love2D
      uses: actions/checkout@v4
      with:
        path: megasource/libs/love
    
    # 3. 配置和编译
    - name: Configure and Build
      run: |
        cd megasource
        cmake -B build -S . -T v143 -A x64
        cmake --build build --config Release --target PACKAGE
    
    # 4. 收集结果
    - name: Collect Results
      run: |
        echo "=== 编译结果 ==="
        
        # 找到生成的ZIP文件
        if (Test-Path "megasource/build/love-12.0-win64.zip") {
            $zipFile = Get-Item "megasource/build/love-12.0-win64.zip"
            $sizeMB = [math]::Round($zipFile.Length / 1MB, 2)
            Write-Host "✅ 找到ZIP包: $($zipFile.Name) ($sizeMB MB)"
            Copy-Item $zipFile.FullName .\
        }
        
        # 查找exe文件
        $exeFiles = Get-ChildItem -Path megasource -Recurse -Filter "love.exe" -File
        if ($exeFiles.Count -gt 0) {
            foreach ($exe in $exeFiles) {
                $sizeMB = [math]::Round($exe.Length / 1MB, 2)
                Write-Host "找到: $($exe.FullName) ($sizeMB MB)"
                if ($sizeMB -gt 5) {
                    Copy-Item $exe.FullName .\love_big.exe
                }
            }
        }
    
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: love2d-complete
        path: |
          *.zip
          *.exe
        if-no-files-found: error
