name: Build Love2D with Chinese Support

on:
  workflow_dispatch:

jobs:
  build-windows-chinese:
    runs-on: windows-latest
    
    steps:
    - name: Clone Megasource
      uses: actions/checkout@v4
      with:
        repository: love2d/megasource
        path: megasource
        submodules: true
    
    - name: Checkout Love2D
      uses: actions/checkout@v4
      with:
        path: megasource/libs/love
    
    - name: Patch for Chinese support
      run: |
        echo "=== Patching for Chinese support ==="
        
        # 修复字体配置
        $fontConfig = "megasource/libs/love/src/modules/graphics/opengl/Font.cpp"
        if (Test-Path $fontConfig) {
            Copy-Item $fontConfig "$fontConfig.backup"
            (Get-Content $fontConfig) | ForEach-Object {
                if ($_ -match 'std::vector<std::string> fallbacks;') {
                    'std::vector<std::string> fallbacks = {"Microsoft YaHei", "SimHei", "NSimSun", "FangSong", "KaiTi", "SimSun", "Microsoft JhengHei"};'
                } else {
                    $_
                }
            } | Set-Content $fontConfig
            Write-Host "✓ Font fallback chain updated"
        }
    
    - name: Configure CMake
      run: |
        cd megasource
        cmake -B build -S . -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: |
        cd megasource
        cmake --build build --config Release --target love
    
    - name: Find executable
      run: |
        echo "=== Searching for executable ==="
        
        $exeFiles = @()
        if (Test-Path "megasource/build/src/Release/love.exe") {
            $exeFiles += "megasource/build/src/Release/love.exe"
        }
        if (Test-Path "megasource/build/Release/love.exe") {
            $exeFiles += "megasource/build/Release/love.exe"
        }
        if (Test-Path "megasource/install/bin/love.exe") {
            $exeFiles += "megasource/install/bin/love.exe"
        }
        
        if ($exeFiles.Count -eq 0) {
            # 搜索所有exe文件
            $allExes = Get-ChildItem -Path megasource -Recurse -Filter "*.exe" -File
            if ($allExes.Count -gt 0) {
                $largest = $allExes | Sort-Object Length -Descending | Select-Object -First 1
                $exeFiles += $largest.FullName
            }
        }
        
        if ($exeFiles.Count -gt 0) {
            $source = $exeFiles[0]
            Copy-Item $source .\love.exe -Force
            $size = (Get-Item .\love.exe).Length
            $sizeMB = [math]::Round($size / 1MB, 2)
            Write-Host "✓ Found: $source ($sizeMB MB)"
        } else {
            Write-Host "❌ No executable found"
        }
    
    - name: Upload result
      uses: actions/upload-artifact@v4
      with:
        name: love2d-chinese
        path: love.exe
