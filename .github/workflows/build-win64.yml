name: Build Love2D for Windows 64-bit

on:
  workflow_dispatch:  # 只手动触发，不自动运行

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    # 1. 首先克隆 megasource（Windows依赖库仓库）
    - name: Clone Megasource
      uses: actions/checkout@v4
      with:
        repository: love2d/megasource
        path: megasource
    
    # 2. 然后将你的love2d代码克隆到megasource的正确位置
    - name: Checkout Love2D into megasource
      uses: actions/checkout@v4
      with:
        path: megasource/libs/love
    
    # 3. 配置CMake（在megasource目录内）
    - name: Configure CMake with Megasource
      run: |
        cd megasource
        cmake -B build -S . -G "Visual Studio 17 2022" -A x64
    
    # 4. 开始编译
    - name: Build
      run: |
        cd megasource
        cmake --build build --config Release --target PACKAGE
    
    # 5. 查找并准备编译好的文件
    - name: Find compiled files
      run: |
        echo "=== 查找编译生成的文件 ==="
        cd megasource/build
        # 查找.exe文件
        Get-ChildItem -Recurse -Filter "*.exe" | ForEach-Object {
          Write-Host "找到可执行文件: $($_.FullName)"
          if ($_.Name -match "love") {
            Copy-Item $_ ..\..\love.exe -Force
            Write-Host "已复制为 love.exe"
          }
        }
        
        # 查找.zip打包文件
        Get-ChildItem -Filter "*.zip" | ForEach-Object {
          Write-Host "找到打包文件: $($_.Name)"
          Copy-Item $_ ..\..\
        }
        
        # 检查结果
        cd ../..
        if (Test-Path "love.exe") {
          Write-Host "✓ 成功: 找到 love.exe"
        } else {
          Write-Host "⚠ 未找到 love.exe，尝试其他位置..."
          # 尝试其他可能的位置
          if (Test-Path "megasource/install/bin/love.exe") {
            Copy-Item "megasource/install/bin/love.exe" .\
          }
        }
    
    # 6. 上传编译结果
    - name: Upload Windows 64-bit binary
      uses: actions/upload-artifact@v4
      with:
        name: love2d-windows-x64
        path: |
          love.exe
          *.zip
          megasource/build/*.exe
          megasource/build/*.zip
        if-no-files-found: warn
