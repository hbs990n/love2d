name: Build Love2D Windows (简化版)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025  # 官方用的版本
    
    steps:
    # 1. 克隆 megasource
    - name: Clone Megasource
      uses: actions/checkout@v4
      with:
        repository: love2d/megasource
        path: megasource
    
    # 2. 克隆你的 love2d
    - name: Clone Love2D
      uses: actions/checkout@v4
      with:
        path: megasource/libs/love
    
    # 3. 配置CMake（完全按照官方参数）
    - name: Configure CMake
      run: |
        cd megasource
        cmake -B build -S . -T v143 -A x64,version=10.0.26100.0 --install-prefix install
    
    # 4. 编译（官方用PACKAGE目标）
    - name: Build Package
      run: |
        cd megasource
        cmake --build build --config Release --target PACKAGE
    
    # 5. 同时编译install目标获取可执行文件
    - name: Build Install
      run: |
        cd megasource
        cmake --build build --config Release --target install
    
    # 6. 查找和准备文件
    - name: Find Compiled Files
      run: |
        echo "=== 查找编译结果 ==="
        
        # 先找PACKAGE生成的文件
        if (Test-Path "megasource/build/*.exe") {
            Get-ChildItem "megasource/build/*.exe" | ForEach-Object {
                $sizeMB = [math]::Round($_.Length / 1MB, 2)
                Write-Host "打包文件: $($_.Name) ($sizeMB MB)"
                Copy-Item $_ .\
            }
        }
        
        # 找install目录的文件
        if (Test-Path "megasource/install/bin/love.exe") {
            $file = Get-Item "megasource/install/bin/love.exe"
            $sizeMB = [math]::Round($file.Length / 1MB, 2)
            Write-Host "安装文件: love.exe ($sizeMB MB)"
            Copy-Item $file .\love_install.exe
        }
        
        # 列出所有可能的位置
        Write-Host "`n所有可能的exe文件:"
        Get-ChildItem -Path megasource -Recurse -Filter "*.exe" -File | ForEach-Object {
            $sizeMB = [math]::Round($_.Length / 1MB, 2)
            Write-Host "  - $($_.FullName) ($sizeMB MB)"
        }
    
    # 7. 上传所有找到的文件
    - name: Upload All Results
      uses: actions/upload-artifact@v4
      with:
        name: love2d-windows-build
        path: |
          *.exe
          megasource/build/*.exe
          megasource/build/*.zip
        if-no-files-found: warn
