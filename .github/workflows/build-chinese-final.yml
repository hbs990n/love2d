name: Build Love2D with Chinese Fonts
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Clone repositories
      run: |
        git clone https://github.com/love2d/megasource.git
        git clone https://github.com/${{ github.repository }}.git megasource/libs/love
    
    - name: Download fonts
      run: |
        mkdir megasource/chinese-fonts
        curl -L -o megasource/chinese-fonts/font1.otf "https://github.com/adobe-fonts/source-han-sans/raw/release/OTF/SimplifiedChinese/SourceHanSansSC-Regular.otf"
        curl -L -o megasource/chinese-fonts/font2.otf "https://github.com/adobe-fonts/source-han-serif/raw/release/OTF/SimplifiedChinese/SourceHanSerifSC-Regular.otf"
    
    - name: Configure
      run: |
        cd megasource
        cmake -B build -S .
    
    - name: Build
      run: |
        cd megasource
        cmake --build build --config Release
    
    - name: Prepare output
      run: |
        mkdir output
        # 复制exe
        $exe = Get-ChildItem -Path megasource/build -Recurse -Filter "love.exe" -File | Select-Object -First 1
        if ($exe) {
            Copy-Item $exe.FullName output/love.exe
        }
        # 复制字体
        Copy-Item megasource/chinese-fonts output/ -Recurse
        # 创建测试文件
        echo 'function love.draw()
    love.graphics.print("Test中文", 100, 100)
end' > output/test.lua
    
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: love-chinese
        path: output/
