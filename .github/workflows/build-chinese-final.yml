name: Build Love2D with Chinese Fonts

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025
    
    steps:
    - name: Clone Megasource
      uses: actions/checkout@v4
      with:
        repository: love2d/megasource
        path: megasource
    
    - name: Clone Love2D
      uses: actions/checkout@v4
      with:
        path: megasource/libs/love
    
    - name: Download Chinese fonts
      run: |
        echo "下载中文字体..."
        mkdir -Force "megasource/chinese-fonts"
        
        # 下载字体
        curl -L -o "megasource/chinese-fonts/SourceHanSansSC-Regular.otf" "https://github.com/adobe-fonts/source-han-sans/raw/release/OTF/SimplifiedChinese/SourceHanSansSC-Regular.otf"
        curl -L -o "megasource/chinese-fonts/SourceHanSerifSC-Regular.otf" "https://github.com/adobe-fonts/source-han-serif/raw/release/OTF/SimplifiedChinese/SourceHanSerifSC-Regular.otf"
        curl -L -o "megasource/chinese-fonts/NotoSansSC-Regular.otf" "https://github.com/googlefonts/noto-cjk/raw/main/Sans/OTF/SimplifiedChinese/NotoSansSC-Regular.otf"
        
        echo "字体下载完成"
    
    - name: Configure CMake
      run: |
        cd megasource
        cmake -B build -S . -T v143 -A x64 --install-prefix install
    
    - name: Build
      run: |
        cd megasource
        cmake --build build --config Release --target PACKAGE
        cmake --build build --config Release --target install
    
    - name: Prepare output
      run: |
        mkdir -Force "output"
        mkdir -Force "output/chinese-fonts"
        
        # 复制字体
        if (Test-Path "megasource/chinese-fonts") {
            Copy-Item "megasource/chinese-fonts/*" "output/chinese-fonts/" -Force
        }
        
        # 复制exe文件
        if (Test-Path "megasource/install/bin/love.exe") {
            Copy-Item "megasource/install/bin/love.exe" "output/love.exe" -Force
        } else {
            $exe = Get-ChildItem -Path "megasource/build" -Recurse -Filter "love.exe" -File | Select-Object -First 1
            if ($exe) {
                Copy-Item $exe.FullName "output/love.exe" -Force
            }
        }
        
        # 创建demo文件
        $demo = @'
function love.load()
    print("中文测试开始")
    
    local function loadFont()
        local fonts = {
            "chinese-fonts/SourceHanSansSC-Regular.otf",
            "chinese-fonts/SourceHanSerifSC-Regular.otf",
            "chinese-fonts/NotoSansSC-Regular.otf"
        }
        
        for i, path in ipairs(fonts) do
            local success, font = pcall(love.graphics.newFont, path, 16)
            if success then
                print("使用字体: " .. path)
                return font
            end
        end
        return love.graphics.newFont(16)
    end
    
    love.graphics.setFont(loadFont())
end

function love.draw()
    love.graphics.print("中文测试: 你好，世界！", 50, 50)
    love.graphics.print("Love2D 游戏引擎", 50, 80)
end
'@
        Set-Content -Path "output/demo.lua" -Value $demo -Encoding UTF8
        
        echo "文件准备完成"
    
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: love2d-chinese
        path: output/
