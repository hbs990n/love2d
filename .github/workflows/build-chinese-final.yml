name: Build Love2D with Chinese Fonts

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025
    
    steps:
    # 1. 克隆 megasource
    - name: Clone Megasource
      uses: actions/checkout@v4
      with:
        repository: love2d/megasource
        path: megasource
    
    # 2. 克隆你的 love2d
    - name: Clone Love2D
      uses: actions/checkout@v4
      with:
        path: megasource/libs/love
    
    # 3. 下载字体（只下载思源黑体，最常用）
    - name: Download Chinese font
      run: |
        mkdir -Force "megasource/chinese-fonts"
        
        # 只下载一个字体，减少体积和复杂度
        curl -L -o "megasource/chinese-fonts/SourceHanSansSC-Regular.otf" ^
          "https://github.com/adobe-fonts/source-han-sans/raw/release/OTF/SimplifiedChinese/SourceHanSansSC-Regular.otf"
        
        echo "字体下载完成"
    
    # 4. 配置CMake
    - name: Configure CMake
      run: |
        cd megasource
        cmake -B build -S . -T v143 -A x64 --install-prefix install
    
    # 5. 编译
    - name: Build
      run: |
        cd megasource
        cmake --build build --config Release --target PACKAGE
    
    # 6. 整理输出
    - name: Prepare output
      run: |
        # 创建干净的输出目录
        mkdir -Force "output"
        
        # 复制字体
        if (Test-Path "megasource/chinese-fonts") {
          Copy-Item "megasource/chinese-fonts" "output/" -Recurse -Force
        }
        
        # 查找并复制exe文件
        $exePath = $null
        
        # 先找install目录
        if (Test-Path "megasource/install/bin/love.exe") {
          $exePath = "megasource/install/bin/love.exe"
        }
        # 再找build目录
        elseif (Test-Path "megasource/build/Release/love.exe") {
          $exePath = "megasource/build/Release/love.exe"
        }
        # 最后搜索
        else {
          $found = Get-ChildItem -Path "megasource/build" -Recurse -Filter "love.exe" -File | Select-Object -First 1
          if ($found) {
            $exePath = $found.FullName
          }
        }
        
        if ($exePath) {
          Copy-Item $exePath "output/love.exe" -Force
          $sizeMB = [math]::Round((Get-Item $exePath).Length / 1MB, 2)
          echo "找到 love.exe ($sizeMB MB)"
        } else {
          echo "警告: 未找到 love.exe"
        }
    
    # 7. 上传结果
    - name: Upload result
      uses: actions/upload-artifact@v4
      with:
        name: love2d-chinese-simple
        path: |
          output/
