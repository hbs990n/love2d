name: Build Love2D with Chinese Fonts

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025
    
    steps:
    # 1. 克隆 megasource
    - name: Clone Megasource
      uses: actions/checkout@v4
      with:
        repository: love2d/megasource
        path: megasource
    
    # 2. 克隆你的 love2d
    - name: Clone Love2D
      uses: actions/checkout@v4
      with:
        path: megasource/libs/love
    
    # 3. 配置CMake
    - name: Configure CMake
      run: |
        cd megasource
        echo "配置CMake..."
        
        # 获取当前绝对路径
        $currentDir = (Get-Location).Path
        $installPath = "$currentDir\install"
        echo "安装路径: $installPath"
        
        # 配置CMake
        cmake -B build -S . -T v143 -A x64 --install-prefix "$installPath"
        
        echo "CMake配置完成"
    
    # 4. 编译（修复install目标可能失败的问题）
    - name: Build
      run: |
        cd megasource
        echo "开始编译..."
        
        # 主要编译目标
        cmake --build build --config Release
        
        echo "主要编译完成"
        
        # 尝试PACKAGE目标（可能失败，但继续）
        echo "尝试PACKAGE目标..."
        cmake --build build --config Release --target PACKAGE 2>&1 | Out-Null
        echo "PACKAGE尝试完成"
        
        # 尝试install目标（可能失败，但继续）
        echo "尝试install目标..."
        cmake --build build --config Release --target install 2>&1 | Out-Null
        echo "install尝试完成"
        
        echo "所有编译尝试完成"
    
    # 5. 准备输出文件（关键：无论编译如何，都尝试收集文件）
    - name: Prepare output files
      run: |
        echo "=== 准备输出文件 ==="
        
        # 创建输出目录
        Remove-Item -Path "output" -Recurse -Force -ErrorAction SilentlyContinue
        mkdir -Force "output"
        
        # 1. 查找所有可能的exe文件（按优先级）
        $exeFound = $false
        
        # 优先级1：install目录
        if (Test-Path "megasource/install/bin/love.exe") {
          Copy-Item "megasource/install/bin/love.exe" "output/love.exe" -Force
          $exeFound = $true
          $sizeMB = [math]::Round((Get-Item "megasource/install/bin/love.exe").Length / 1MB, 2)
          echo "✓ 找到 love.exe ($sizeMB MB) - 来自install目录"
        }
        
        # 优先级2：build/Release目录
        if (-not $exeFound -and (Test-Path "megasource/build/Release/love.exe")) {
          Copy-Item "megasource/build/Release/love.exe" "output/love.exe" -Force
          $exeFound = $true
          $sizeMB = [math]::Round((Get-Item "megasource/build/Release/love.exe").Length / 1MB, 2)
          echo "✓ 找到 love.exe ($sizeMB MB) - 来自build/Release"
        }
        
        # 优先级3：搜索所有love.exe
        if (-not $exeFound) {
          $exeFiles = Get-ChildItem -Path "megasource/build" -Recurse -Filter "love.exe" -File
          if ($exeFiles.Count -gt 0) {
            $exeFile = $exeFiles[0]
            Copy-Item $exeFile.FullName "output/love.exe" -Force
            $exeFound = $true
            $sizeMB = [math]::Round($exeFile.Length / 1MB, 2)
            echo "✓ 找到 love.exe ($sizeMB MB) - 来自搜索"
          }
        }
        
        # 优先级4：搜索任何exe文件
        if (-not $exeFound) {
          $allExeFiles = Get-ChildItem -Path "megasource/build" -Recurse -Filter "*.exe" -File
          if ($allExeFiles.Count -gt 0) {
            # 找最大的exe文件（通常是主程序）
            $largestExe = $allExeFiles | Sort-Object Length -Descending | Select-Object -First 1
            Copy-Item $largestExe.FullName "output/love.exe" -Force
            $exeFound = $true
            $sizeMB = [math]::Round($largestExe.Length / 1MB, 2)
            echo "✓ 找到最大的exe文件 ($sizeMB MB) - 重命名为love.exe"
          }
        }
        
        if (-not $exeFound) {
          echo "⚠ 未找到任何exe文件"
        }
        
        # 2. 查找ZIP包
        $zipFiles = Get-ChildItem -Path "megasource/build" -Filter "*.zip" -File
        if ($zipFiles.Count -gt 0) {
          foreach ($zip in $zipFiles) {
            Copy-Item $zip.FullName "output/$($zip.Name)" -Force
            $sizeMB = [math]::Round($zip.Length / 1MB, 2)
            echo "✓ 复制 $($zip.Name) ($sizeMB MB)"
          }
        }
        
        # 3. 如果输出目录有文件，显示信息
        if (Test-Path "output/*") {
          echo "`n输出目录内容:"
          Get-ChildItem "output" -File | ForEach-Object {
            $sizeKB = [math]::Round($_.Length / 1KB, 1)
            echo "  - $($_.Name) ($sizeKB KB)"
          }
        } else {
          echo "⚠ 输出目录为空"
          # 创建占位文件，避免上传失败
          echo "编译输出为空" | Out-File "output/empty.txt"
        }
    
    # 6. 上传编译结果（即使文件很少也上传）
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: love2d-build-result
        path: output/
        if-no-files-found: warn
